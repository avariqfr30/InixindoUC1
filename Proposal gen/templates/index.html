<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Proposal System</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; color: #334155; }
        .card { background: white; padding: 50px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); width: 640px; }
        .hidden { display: none; }
        h2 { color: #0f172a; margin: 0 0 10px 0; font-size: 1.8rem; }
        p.sub { color: #64748b; margin: 0 0 30px 0; font-size: 1rem; }
        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.95rem; }
        select, button { width: 100%; padding: 14px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 1.05rem; background: white; }
        select:focus { border-color: #3b82f6; outline: none; }
        button { background: #2563eb; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }
        button.secondary { background: white; color: #475569; border: 1px solid #cbd5e1; }
        button.secondary:hover { background: #f8fafc; }
        .review-box { background: #f8fafc; padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .review-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1rem; }
        .review-row span:last-child { font-weight: 600; color: #0f172a; }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; display: none; vertical-align: middle; margin-left: 10px; }
        .spinner.active { display: inline-block; }
        .error-text { color: #ef4444; font-weight: 600; margin-bottom: 15px; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="card">
        <div id="loader" style="text-align:center; padding: 40px;">
            <div style="border:4px solid #e2e8f0; border-top:4px solid #3b82f6; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 20px auto;"></div>
            <p id="loader-text">Memuat Sistem...</p>
        </div>

        <div id="step-config" class="hidden">
            <h2>Inixindo Strategic Proposal System</h2>
            <p class="sub">AI-Powered Consultant Workspace</p>
            
            <label id="label-top">Klien / Entitas</label>
            <select id="select-top"></select>
            
            <div id="container-sub" class="hidden">
                <label id="label-sub">Inisiatif Strategis</label>
                <select id="select-sub"></select>
            </div>
            
            <button id="btn-review" disabled>Lanjut Tinjau Data</button>
            <button id="btn-refresh" class="secondary" style="font-size:0.9rem; padding:10px;">ðŸ”„ Refresh Database (CSV)</button>
        </div>

        <div id="step-review" class="hidden">
            <h2>Konfirmasi Detail</h2>
            <p class="sub">Pastikan data berikut sudah benar.</p>
            <div class="review-box" id="review-text"></div>
            <div style="display:flex; gap:15px;">
                <button id="btn-back" class="secondary" style="width:35%">Kembali</button>
                <button id="btn-generate" style="width:65%">Generate Dokumen <span id="spinner" class="spinner"></span></button>
            </div>
        </div>

        <div id="step-success" class="hidden" style="text-align:center; padding: 20px;">
            <div style="font-size: 60px; margin-bottom: 20px;">âœ…</div>
            <h2>Selesai!</h2>
            <p class="sub">Dokumen telah berhasil disusun dan diunduh.</p>
            <button onclick="location.reload()" class="secondary">Buat Proposal Baru</button>
        </div>
    </div>

    <script>
        let databaseStructure = {}; 
        
        const ui = {
            loader: document.getElementById('loader'),
            loaderText: document.getElementById('loader-text'),
            configStep: document.getElementById('step-config'),
            reviewStep: document.getElementById('step-review'),
            successStep: document.getElementById('step-success'),
            
            selectTop: document.getElementById('select-top'),
            selectSub: document.getElementById('select-sub'),
            containerSub: document.getElementById('container-sub'),
            
            labelTop: document.getElementById('label-top'),
            labelSub: document.getElementById('label-sub'),
            reviewText: document.getElementById('review-text'),
            
            btnReview: document.getElementById('btn-review'),
            btnGenerate: document.getElementById('btn-generate'),
            btnRefresh: document.getElementById('btn-refresh'),
            btnBack: document.getElementById('btn-back'),
            spinner: document.getElementById('spinner')
        };
        
        function loadConfig() {
            fetch('/get-config')
                .then(response => {
                    if (!response.ok) throw new Error("Database Load Failed. Is db.csv missing?");
                    return response.json();
                })
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    
                    databaseStructure = data.structure; 
                    ui.labelTop.innerText = data.labels[0] || "Client"; 
                    ui.labelSub.innerText = data.labels[1] || "Project";
                    
                    ui.selectTop.innerHTML = '<option disabled selected>Pilih Opsi...</option>';
                    Object.keys(databaseStructure).forEach(key => { 
                        let option = document.createElement('option'); 
                        option.value = key; 
                        option.text = key; 
                        ui.selectTop.add(option); 
                    });
                    
                    ui.loader.classList.add('hidden'); 
                    ui.configStep.classList.remove('hidden');
                })
                .catch(err => {
                    console.error("Initialization error:", err);
                    ui.loaderText.innerHTML = `<span class="error-text">${err.message}</span>`;
                });
        }
        
        // Initialize
        loadConfig();

        // Event Listeners
        ui.btnRefresh.onclick = () => {
            ui.btnRefresh.innerText = "Refreshing..."; 
            ui.btnRefresh.disabled = true;
            fetch('/refresh-knowledge', {method: 'POST'})
                .then(response => response.json())
                .then(res => { 
                    alert("Database Refreshed"); 
                    location.reload(); 
                })
                .catch(err => {
                    console.error("Failed to refresh:", err);
                    ui.btnRefresh.innerText = "ðŸ”„ Refresh Database (CSV)";
                    ui.btnRefresh.disabled = false;
                });
        };

        ui.selectTop.onchange = () => { 
            ui.selectSub.innerHTML = ""; 
            databaseStructure[ui.selectTop.value].options.forEach(opt => { 
                let option = document.createElement('option'); 
                option.value = opt; 
                option.text = opt; 
                ui.selectSub.add(option); 
            }); 
            ui.containerSub.classList.remove('hidden'); 
            ui.btnReview.disabled = false; 
        };
        
        ui.btnReview.onclick = () => { 
            const html = `
                <div class="review-row"><span>Klien</span><span>${ui.selectTop.value}</span></div>
                <div class="review-row"><span>Inisiatif</span><span>${ui.selectSub.value}</span></div>
                <div class="review-row"><span>Konsultan</span><span style="color:#2563eb">Inixindo Jogja</span></div>
            `;
            ui.reviewText.innerHTML = html; 
            ui.configStep.classList.add('hidden'); 
            ui.reviewStep.classList.remove('hidden'); 
        };
        
        ui.btnBack.onclick = () => { 
            ui.reviewStep.classList.add('hidden'); 
            ui.configStep.classList.remove('hidden'); 
        };
        
        ui.btnGenerate.onclick = () => {
            ui.btnGenerate.disabled = true; 
            ui.spinner.classList.add('active');
            
            const payload = {
                topic: ui.selectTop.value, 
                sub_topic: ui.selectSub.value
            };

            fetch('/generate', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(payload) 
            })
            .then(response => {
                if (!response.ok) throw new Error("Document generation failed on server.");
                return response.blob();
            })
            .then(blob => {
                let url = window.URL.createObjectURL(blob);
                let a = document.createElement('a'); 
                a.href = url; 
                a.download = `Proposal_${ui.selectTop.value}.docx`; 
                a.click();
                
                // Cleanup to prevent memory leaks
                window.URL.revokeObjectURL(url);
                
                ui.reviewStep.classList.add('hidden'); 
                ui.successStep.classList.remove('hidden');
            })
            .catch(err => {
                console.error("Document generation failed:", err);
                alert("Failed to generate document. Check server logs.");
                ui.btnGenerate.disabled = false;
                ui.spinner.classList.remove('active');
            });
        };
    </script>
</body>
</html>